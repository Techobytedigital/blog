---
name: "Test Blog Links"

on:
  workflow_dispatch:
  schedule:
    ## Every 6 hours
    - cron: "0 */6 * * *"

permissions:
  contents: read
  issues: write

jobs:
  test:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
    steps:
      - name: Test live site links
        id: lychee
        uses: lycheeverse/lychee-action@v1
        with:
          args: >-
            --verbose
            --no-progress
            --exclude-all-private
            --max-requests-per-minute 10
            --user-agent "Mozilla/5.0 (compatible; Lychee/0.15.0; +https://lychee.cli.rs)"
            "${{ vars.HUGO_BASEURL }}/sitemap.xml"
            "${{ vars.HUGO_BASEURL }}/posts/sitemap.xml"
          format: markdown
          output: lychee-report.md
          jobSummary: true
          fail: true

      - name: Show lychee report
        if: always()
        run: |
          echo "## Lychee Results" >> $GITHUB_STEP_SUMMARY
          echo '```markdown' >> $GITHUB_STEP_SUMMARY
          cat lychee-report.md >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload lychee report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lychee-report
          path: lychee-report.md
